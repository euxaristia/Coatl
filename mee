#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "$0")" && pwd)"
SELFHOST_BUILD="$ROOT_DIR/selfhost/build_with_selfhost.sh"
RUST_COMPILER_DIR="$ROOT_DIR/compiler"
SEED_DEFAULT="$ROOT_DIR/selfhost/bootstrap.seed.wat"
SUBSET_FRONTEND="$ROOT_DIR/tools/mee_subset_to_ir.py"
IR_TO_X86_ASM="$ROOT_DIR/tools/ir_to_x86_64_asm.py"

usage() {
  cat <<'EOF'
usage:
  ./mee build <input.mee> [--emit=wat|asm|ir] [-o <output>] [--toolchain=auto|selfhost|rust|ir] [--compiler <seed.wat>]
  ./mee lower-ir <input.ir> -o <output.wat>

notes:
  - default toolchain is "auto" (or $MEE_TOOLCHAIN), preferring selfhost for --emit=wat
  - toolchain=ir uses IR + external non-Rust lowerer; frontend is Rust by default, subset non-Rust in strict mode
  - --emit=asm supports toolchain=ir for subset/non-Rust lane (with Rust fallback unless MEE_NO_RUST=1)
  - --emit=ir supports toolchain=ir (subset frontend)
  - set MEE_NO_RUST=1 to forbid any Rust compiler usage/fallback
  - set MEE_NO_RUST_BUILD=1 to force no-Rust behavior for branch-mode development
EOF
}

if [[ $# -lt 2 ]]; then
  usage
  exit 1
fi

cmd="$1"
if [[ "$cmd" == "lower-ir" ]]; then
  input_ir="$2"
  shift 2
  out_wat=""
  while [[ $# -gt 0 ]]; do
    case "$1" in
      -o)
        out_wat="${2:-}"
        shift 2
        ;;
      *)
        echo "unknown arg: $1"
        usage
        exit 1
        ;;
    esac
  done
  if [[ -z "$out_wat" ]]; then
    echo "missing -o <output.wat>"
    exit 1
  fi
  if [[ ! -f "$input_ir" ]]; then
    echo "input IR file not found: $input_ir"
    exit 1
  fi
  "$ROOT_DIR/tools/ir_to_wat.py" "$input_ir" -o "$out_wat"
  exit 0
fi

if [[ "$cmd" != "build" ]]; then
  usage
  exit 1
fi

input="$2"
if [[ ! -f "$input" ]]; then
  echo "input file not found: $input"
  exit 1
fi
input_abs="$(realpath "$input")"

emit="wat"
out=""
toolchain="${MEE_TOOLCHAIN:-auto}"
seed="$SEED_DEFAULT"

shift 2
while [[ $# -gt 0 ]]; do
  case "$1" in
    --emit=*)
      emit="${1#--emit=}"
      shift
      ;;
    -o)
      out="${2:-}"
      shift 2
      ;;
    --toolchain=*)
      toolchain="${1#--toolchain=}"
      shift
      ;;
    --compiler)
      seed="${2:-}"
      shift 2
      ;;
    *)
      echo "unknown arg: $1"
      usage
      exit 1
      ;;
  esac
done

if [[ "$emit" != "wat" && "$emit" != "asm" && "$emit" != "ir" ]]; then
  echo "unsupported emit target: $emit"
  exit 1
fi
if [[ "$toolchain" != "auto" && "$toolchain" != "selfhost" && "$toolchain" != "rust" && "$toolchain" != "ir" ]]; then
  echo "unsupported toolchain: $toolchain"
  exit 1
fi
out_abs=""
if [[ -n "$out" ]]; then
  out_abs="$(realpath -m "$out")"
fi

rust_disabled() {
  [[ "${MEE_NO_RUST:-0}" == "1" || "${MEE_NO_RUST_BUILD:-0}" == "1" ]]
}

no_rust_build_mode() {
  [[ "${MEE_NO_RUST_BUILD:-0}" == "1" ]]
}

ensure_rust_allowed() {
  if rust_disabled; then
    echo "rust-disabled mode: this operation requires Rust compiler usage" >&2
    exit 1
  fi
}

rust_build() {
  ensure_rust_allowed
  local emit_flag="--emit=$emit"
  if [[ -n "$out_abs" ]]; then
    (cd "$RUST_COMPILER_DIR" && cargo run --quiet -- build "$input_abs" "$emit_flag" -o "$out_abs")
  else
    (cd "$RUST_COMPILER_DIR" && cargo run --quiet -- build "$input_abs" "$emit_flag")
  fi
}

selfhost_build_wat() {
  local tmp_out=""
  local validate_tmp=""
  validate_tmp="$(mktemp /tmp/mee-selfhost-validate.XXXXXX.cwasm)"
  rm -f "$validate_tmp"
  if [[ -n "$out_abs" ]]; then
    "$SELFHOST_BUILD" build "$input_abs" -o "$out_abs" --compiler "$seed" >/dev/null
    if command -v wasmtime >/dev/null 2>&1; then
      if ! wasmtime compile "$out_abs" -o "$validate_tmp" >/dev/null 2>&1; then
        rm -f "$validate_tmp"
        echo "self-host compile produced invalid WAT module" >&2
        return 1
      fi
      rm -f "$validate_tmp"
    fi
  else
    tmp_out="$(mktemp /tmp/mee-selfhost-out.XXXXXX.wat)"
    "$SELFHOST_BUILD" build "$input_abs" -o "$tmp_out" --compiler "$seed" >/dev/null
    if command -v wasmtime >/dev/null 2>&1; then
      if ! wasmtime compile "$tmp_out" -o "$validate_tmp" >/dev/null 2>&1; then
        rm -f "$tmp_out" "$validate_tmp"
        echo "self-host compile produced invalid WAT module" >&2
        return 1
      fi
      rm -f "$validate_tmp"
    fi
    cat "$tmp_out"
    rm -f "$tmp_out"
  fi
}

ir_pipeline_build_wat() {
  local tmp_ir
  local tmp_wat
  local subset_err
  local lower_err
  tmp_ir="$(mktemp /tmp/mee-ir-pipeline.XXXXXX.ir)"
  tmp_wat="$(mktemp /tmp/mee-ir-pipeline.XXXXXX.wat)"
  subset_err="$(mktemp /tmp/mee-ir-pipeline.XXXXXX.subset.err)"
  lower_err="$(mktemp /tmp/mee-ir-pipeline.XXXXXX.lower.err)"
  if [[ -x "$SUBSET_FRONTEND" ]]; then
    if "$SUBSET_FRONTEND" "$input_abs" -o "$tmp_ir" 2>"$subset_err"; then
      if "$ROOT_DIR/tools/ir_to_wat.py" "$tmp_ir" -o "$tmp_wat" 2>"$lower_err"; then
        if [[ -n "$out_abs" ]]; then
          cp "$tmp_wat" "$out_abs"
        else
          cat "$tmp_wat"
        fi
        rm -f "$tmp_ir" "$tmp_wat" "$subset_err" "$lower_err"
        return 0
      fi
      if rust_disabled; then
        echo "subset frontend produced unsupported IR for lowerer and Rust is disabled" >&2
        rm -f "$tmp_ir" "$tmp_wat" "$subset_err" "$lower_err"
        return 1
      fi
      echo "warning: subset IR lowering failed, trying Rust frontend in ir pipeline" >&2
    fi
  fi

  if rust_disabled; then
    echo "subset frontend failed for toolchain=ir and Rust is disabled" >&2
    rm -f "$tmp_ir" "$tmp_wat" "$subset_err" "$lower_err"
    return 1
  fi

  if ! (cd "$RUST_COMPILER_DIR" && cargo run --quiet -- build "$input_abs" --emit=ir -o "$tmp_ir"); then
    echo "rust frontend failed for toolchain=ir" >&2
    rm -f "$tmp_ir" "$tmp_wat" "$subset_err" "$lower_err"
    return 1
  fi

  if "$ROOT_DIR/tools/ir_to_wat.py" "$tmp_ir" -o "$tmp_wat" 2>"$lower_err"; then
    if [[ -n "$out_abs" ]]; then
      cp "$tmp_wat" "$out_abs"
    else
      cat "$tmp_wat"
    fi
    rm -f "$tmp_ir" "$tmp_wat" "$subset_err" "$lower_err"
    return 0
  fi

  echo "warning: rust IR could not be lowered by external backend, falling back to rust backend" >&2
  rm -f "$tmp_ir" "$tmp_wat" "$subset_err" "$lower_err"
  if rust_build; then
    return 0
  fi
  return 1
}

subset_emit_ir() {
  if [[ ! -x "$SUBSET_FRONTEND" ]]; then
    return 1
  fi
  if [[ -n "$out_abs" ]]; then
    "$SUBSET_FRONTEND" "$input_abs" -o "$out_abs"
  else
    local tmp_ir
    tmp_ir="$(mktemp /tmp/mee-subset-ir.XXXXXX.ir)"
    "$SUBSET_FRONTEND" "$input_abs" -o "$tmp_ir"
    cat "$tmp_ir"
    rm -f "$tmp_ir"
  fi
  return 0
}

ir_pipeline_build_asm() {
  local tmp_ir
  local tmp_asm
  local subset_err
  local lower_err
  tmp_ir="$(mktemp /tmp/mee-ir-asm-pipeline.XXXXXX.ir)"
  tmp_asm="$(mktemp /tmp/mee-ir-asm-pipeline.XXXXXX.s)"
  subset_err="$(mktemp /tmp/mee-ir-asm-pipeline.XXXXXX.subset.err)"
  lower_err="$(mktemp /tmp/mee-ir-asm-pipeline.XXXXXX.lower.err)"
  if [[ -x "$SUBSET_FRONTEND" ]]; then
    if "$SUBSET_FRONTEND" "$input_abs" -o "$tmp_ir" 2>"$subset_err"; then
      if "$IR_TO_X86_ASM" "$tmp_ir" -o "$tmp_asm" 2>"$lower_err"; then
        if [[ -n "$out_abs" ]]; then
          cp "$tmp_asm" "$out_abs"
        else
          cat "$tmp_asm"
        fi
        rm -f "$tmp_ir" "$tmp_asm" "$subset_err" "$lower_err"
        return 0
      fi
      if rust_disabled; then
        echo "subset frontend produced unsupported IR for asm lowerer and Rust is disabled" >&2
        rm -f "$tmp_ir" "$tmp_asm" "$subset_err" "$lower_err"
        return 1
      fi
      echo "warning: subset asm lowering failed, trying Rust frontend in asm pipeline" >&2
    fi
  fi

  if rust_disabled; then
    echo "subset frontend failed for --emit=asm --toolchain=ir and Rust is disabled" >&2
    rm -f "$tmp_ir" "$tmp_asm" "$subset_err" "$lower_err"
    return 1
  fi

  if ! (cd "$RUST_COMPILER_DIR" && cargo run --quiet -- build "$input_abs" --emit=ir -o "$tmp_ir"); then
    echo "rust frontend failed for --emit=asm --toolchain=ir" >&2
    rm -f "$tmp_ir" "$tmp_asm" "$subset_err" "$lower_err"
    return 1
  fi

  if "$IR_TO_X86_ASM" "$tmp_ir" -o "$tmp_asm" 2>"$lower_err"; then
    if [[ -n "$out_abs" ]]; then
      cp "$tmp_asm" "$out_abs"
    else
      cat "$tmp_asm"
    fi
    rm -f "$tmp_ir" "$tmp_asm" "$subset_err" "$lower_err"
    return 0
  fi

  echo "warning: rust IR could not be lowered by external asm backend, falling back to rust asm backend" >&2
  rm -f "$tmp_ir" "$tmp_asm" "$subset_err" "$lower_err"
  if rust_build; then
    return 0
  fi
  return 1
}

if [[ "$emit" != "wat" ]]; then
  if [[ "$emit" == "asm" ]]; then
    if [[ "$toolchain" == "selfhost" ]]; then
      echo "--emit=$emit is not supported by toolchain=$toolchain"
      exit 1
    fi
    if [[ "$toolchain" == "ir" ]]; then
      ir_pipeline_build_asm
      exit 0
    fi
    if [[ "$toolchain" == "auto" ]]; then
      if ir_pipeline_build_asm; then
        exit 0
      fi
      if rust_disabled; then
        echo "ir asm pipeline failed and Rust fallback is disabled (MEE_NO_RUST=1)" >&2
        exit 1
      fi
      rust_build
      exit 0
    fi
    rust_build
    exit 0
  fi

  # emit=ir
  if [[ "$toolchain" == "ir" ]]; then
    if subset_emit_ir; then
      exit 0
    fi
    echo "subset frontend failed for --emit=ir --toolchain=ir" >&2
    exit 1
  fi
  if [[ "$toolchain" == "auto" ]]; then
    if subset_emit_ir; then
      exit 0
    fi
    if rust_disabled; then
      echo "subset frontend failed and Rust fallback is disabled (MEE_NO_RUST=1)" >&2
      exit 1
    fi
    rust_build
    exit 0
  fi
  if [[ "$toolchain" == "selfhost" ]]; then
    echo "--emit=$emit is not supported by toolchain=$toolchain"
    exit 1
  fi
  rust_build
  exit 0
fi

if [[ "$toolchain" == "rust" ]]; then
  rust_build
  exit 0
fi

if [[ "$toolchain" == "selfhost" ]]; then
  selfhost_build_wat
  exit 0
fi

if [[ "$toolchain" == "ir" ]]; then
  ir_pipeline_build_wat
  exit 0
fi

# auto
if ! no_rust_build_mode && [[ -x "$SELFHOST_BUILD" ]] && command -v wasmtime >/dev/null 2>&1; then
  if selfhost_build_wat; then
    exit 0
  fi
  echo "warning: selfhost build failed, trying ir pipeline" >&2
fi

if ir_pipeline_build_wat; then
  exit 0
fi

if rust_disabled; then
  echo "selfhost/ir pipelines failed and Rust fallback is disabled (MEE_NO_RUST=1)" >&2
  exit 1
fi

echo "warning: ir pipeline failed, falling back to rust backend" >&2

rust_build
