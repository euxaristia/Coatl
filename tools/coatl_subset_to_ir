#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
PY_SCRIPT="$ROOT_DIR/tools/coatl_subset_to_ir.py"
COATL_PYTHON="${COATL_PYTHON:-}"
if [[ -f "$PY_SCRIPT" ]]; then
  if [[ -z "$COATL_PYTHON" ]]; then
    for cand in python3 python; do
      if command -v "$cand" >/dev/null 2>&1; then
        COATL_PYTHON="$cand"
        break
      fi
    done
  fi
  if [[ -n "$COATL_PYTHON" ]]; then
    exec "$COATL_PYTHON" "$PY_SCRIPT" "$@"
  fi
fi

COATL_BIN="${COATL_BIN:-$(command -v coatl || true)}"

if [[ -z "$COATL_BIN" && -x "$ROOT_DIR/coatl" ]]; then
  COATL_BIN="$ROOT_DIR/coatl"
fi
MODULE="/tmp/coatl-subset-to-ir.wat"

if ! command -v wasmtime >/dev/null 2>&1; then
  echo "wasmtime is required but not found in PATH" >&2
  exit 1
fi

if [[ -z "$COATL_BIN" ]]; then
  echo "error: coatl command not found" >&2
  exit 1
fi

usage() {
  cat <<'EOF' >&2
usage:
  tools/coatl_subset_to_ir <input.coatl> -o <output.ir>
EOF
}

if [[ $# -lt 3 ]]; then
  usage
  exit 1
fi

input=""
output=""
input="$1"
shift
while [[ $# -gt 0 ]]; do
  case "$1" in
    -o)
      if [[ $# -lt 2 ]]; then
        echo "missing value for -o" >&2
        usage
        exit 1
      fi
      output="$2"
      shift 2
      ;;
    *)
      echo "unknown arg: $1" >&2
      usage
      exit 1
      ;;
  esac
done

if [[ -z "$output" ]]; then
  echo "missing -o <output.ir>" >&2
  usage
  exit 1
fi

build_module() {
  "$COATL_BIN" build "$ROOT_DIR/tools/coatl_subset_to_ir.coatl" --emit=wat --toolchain=selfhost -o "$MODULE" >/dev/null
}

if [[ ! -f "$MODULE" ]]; then
  build_module
fi

printf '%s -o %s\n' "$input" "$output" | wasmtime --invoke main "$MODULE"
